# 船内フォトサービス
このシステムは、AWSのサーバーレスアーキテクチャ（Lambda,API Gateway,S3）を活用して構築した、**クルーズ乗客向けの時限式写真共有システム**です。

最大の特徴は、**S3の署名付きURL**を動的に生成し、**カタログ生成から30分間限定**での写真へのアクセスを許可する点です。

運営者は「写真アップロードページ」（管理者画面）から写真をアップロードするだけで、システムが自動的に
- 写真一覧のカタログHTMLを生成
- カタログページへアクセスできるQRコードを生成
- 公開用S3バケットへ反映
- 利用者はQRコードを読み取ってカタログページにアクセスし、写真を保存可能

工夫した点
- 現場運用が簡単にできることを追求した。
  - 現場ではQR表示用ページをモニターに常時表示するだけでQRが自動更新される。
- スマホから写真アップロードページにアクセスして写真をアップロードするだけでカタログページの生成からQRの更新までが自動で完結する。

本システムでは、**プライバシー配慮（時間限定公開）**と**現場運用の簡易性**を両立した仕組みに設計しています。
## 本システムを開発した背景
本システムは、大阪・道頓堀で運行される**20分クルーズ**において、**体験価値の向上**と**他社船舶との差別化**を目的に開発しました。

従来は、ガイドスタッフのサービスとしてお客様のスマートフォンをスタッフが預かり、写真撮影を行なっていました。しかしこの運営方法には以下の問題がありました。
- スタッフがスマホを落下・破損するリスクがあり、賠償負担の可能性がある。
- 各グループに対して、「スマホを預かる→撮影→返却」を行うとグリコ看板前などの撮影スポットで全員分撮影しきれない。

そこで、**「スタッフ側で撮影した写真を、乗船者へスムーズに共有できる仕組み」** を整備することでこれらの課題を解決できると考えました。


## システムアーキテクチャ
本サービスに求められた要件は次の通りです。

|要件|補足|
|---------------------------|---------------------------------------------|
|写真を簡単に共有できること|乗客はQRを読み取るだけでOK|
|公開は短時間に限定すること|不特定多数に永続的に公開されないようにする|
|アルバイトでも扱えるシステムにすること|UIをシンプルに|
|ランニングコストを最小化すること|月5000円以内には抑えたい|
|安全なデータ管理|プライバシーとセキュリティの観点から、写真はprivate S3内で厳重に取り扱い|

以上の要件を満たすため、次のアプローチを選択しました。
|採用技術|理由|
|-----------------------|----------------------------------------|
|Amazon S3|写真を厳重に管理し、公開範囲を制御するため|
|署名付きURL|有効期限付きで安全なアクセスを提供するため|
|AWS Lambda|サーバーレスで簡単に構築でき、運用コストも低いため|
|S3 Static Web Hosting|公開カタログの配信を低コストで実現するため|

流れを簡単にまとめると次のようになります。
|フェーズ|内容|担当|
|---------|-------------------|---------|
|撮影・アップロード|撮影した写真をスマホからアップロード|カメラマン|
|カタログページ生成・QR生成|Lambdaがカタログを生成して公開|AWS|
|閲覧|生成されたQRコードを読み取ってカタログページを閲覧|お客様|
|自動削除|公開期限を過ぎた写真とHTMLを自動削除|AWS|

![バックエンドのイメージ](backend.jpg)

AWSの動きを詳述します。本システムは大きく**写真アップロードフロー**と**カタログ生成フロー**に分けられます。

**写真アップロードフロー**

1. 「管理画面」→API Gateway
2. →**Lambda(CreateSignedURL)** で、5分間有効のS3 **PutObject用署名付きURL**を発行
3. 「管理画面」がURLを受け取り、**S3 private**へ画像ファイルを直接アップロード

**カタログ生成フロー**

1. 「管理画面」→API Gateway
2. →**Lambda(CatalogGenerator)** 発火
   1. プライベートS3から写真リストを取得
   2. 30分有効の**S3 GetObject用署名付きURL**を一括発行
   3. カタログページのHTMLを動的に生成
   4. **S3 public** にHTMLを保存し、そのURLのQRコードを生成した上でS3 public内のqrcode.jpgへ上書き
3. 乗客がデジタルサイネージのQRコードを読み取りカタログページへアクセス
## 工夫点
### 1. S3署名付きURLによる**30分限定**のセキュアなアクセス制御
**課題**　乗客のプライバシーを含む写真を、永続的にパブリック公開するのはセキュリティリスクが高い。
**工夫（解決策）**　乗客の写真データはプライベートバケットに厳重に保管し、乗客への公開はLambdaがカタログ生成時に発行する「30分のみ有効なS3署名付きURL(GetObject)」を通じて行います。

これにより、30分が経過するとURLが自動的に失効し、写真データにアクセスできなくなるため、高いセキュリティを担保しています。
```Javascript
import {getSignedUrl} from "@aws-sdk/s3-request-presigner";
import {GetObjectCommand} from "@aws-sdk/client-s3";

//有効期限を30分に設定して署名付きURLを発行
getSignedUrl(s3Client,command,{expiresIn: 60*30});
```

### 2. Promise.allによる署名付きURLの高速並列生成
**課題**　写真が100枚、200枚と増えていった場合、一枚ずつ直列で署名付きURLを発行すると、API GatewayやLambdaのタイムアウトに抵触する可能性があります。
**工夫（解決策）**　`map` を使って署名付きURL発行処理のPromise配列を作成し、`Promise.all`を使って全てのURL発行を並列実行しています。
```Javascript
const urlPromises = photoList.map(photoFileName =>{
  const command = new GetObjectCommand(/*...*/);
  return getSignedUrl(s3Client, command, {expiresIn:60*30})
    .then(signedUrl => ({fileName: photoFileName, url:signedUrl}));
})

const signedPhotoUrls = await Promise.all(urlPromises);
```
### 3. 固定URLへの上書きによるサイネージ運用自動化
**課題**　クルーズの便が変わるたびに、船内のデジタルサイネージに表示するQRコードを手動で更新するのは、非常に手間がかかります。
**工夫（解決策）**　カタログ生成時に、常に固定のファイル名`qrcode.png`に対して新しく生成されたURLのQRコードを上書き保存します。上書きされたQRコードを常に参照できるように、サイネージで表示する`qrcode.html`が10秒ごとにリフレッシュしています。
```Javascript
//QRコードライブラリを使ってQRコードを生成して保存
const qrCodeBuffer = await qrcode.toBuffer(catalogUrl, { 
    type: 'png',
    errorCorrectionLevel: 'H',
    scale: 8 
});

//固定ファイルに上書き
const qrKey = 'qrcode.png';
await putContentToS3(qrKey, qrCodeBuffer, 'image/png');

```
### 4. CSSによる写真の均一なグリッドレイアウト
### 5.　CORSによるアップロードAPIのオリジン限定


## 使用技術
- バックエンド
  - AWS Lambda (Node.js)
  - Amazon API Gateway
  - Amazon S3 (プライベートバケット・静的ウェブサイトホスティング)
  - qrcode生成ライブラリ
- フロントエンド
  - HTML
  - CSS
  - Javascript


